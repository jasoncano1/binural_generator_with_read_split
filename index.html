<!-- Add a simple fallback button as a guaranteed way to activate speech -->
<script>
    // Emergency speech function - can be called from console if needed
    function emergencySpeech() {
        try {
            const text = document.getElementById('speech-text').value;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.8;
            utterance.volume = 0.7;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
            alert("Emergency speech triggered. Check if you can hear the narration.");
        } catch (e) {
            alert("Speech error: " + e.message);
        }
    }


    // Dark mode toggle function (single definition)
    let isDarkMode = false;
    function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').textContent = '☀️';
        } else {
            document.body.classList.remove('dark-mode');
            document.getElementById('theme-icon').textContent = '🌙';
        }
        localStorage.setItem('binaural-dark-mode', isDarkMode ? 'true' : 'false');
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Dark mode initialization and theme toggle events
        const savedDarkMode = localStorage.getItem('binaural-dark-mode');
        if (savedDarkMode === 'true') {
            // isDarkMode is false by default; toggling will set it to true
            toggleDarkMode();
        }
        document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);

        // Speech buttons events
        document.getElementById('speak-btn').onclick = function () {
            startSpeech();
        };
        document.getElementById('stop-speech-btn').onclick = function () {
            stopSpeech();
        };


        // Enable the speak button shortly after audio toggle
        document.getElementById('toggle-btn').addEventListener('click', function () {
            setTimeout(function () {
                if (isPlaying) {
                    document.getElementById('speak-btn').disabled = false;
                } else {
                    document.getElementById('speak-btn').disabled = true;
                }
            }, 500);
        });
    });


    // --- Speech synthesis functions ---
    function loadVoices() {
        voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
            voiceSelect.innerHTML = ''; // Clear dropdown
            voices.forEach((voice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${voice.name} (${voice.lang})`;
                voiceSelect.appendChild(option);
            });
            let englishVoiceIndex = voices.findIndex(voice => voice.lang.includes('en') && !voice.name.includes('Google'));
            if (englishVoiceIndex === -1) {
                englishVoiceIndex = 0;
            }
            voiceSelect.value = englishVoiceIndex;
            // Enable speak button if text is present and audio is playing
            speakBtn.disabled = !(speechText.value.trim().length > 0 && isPlaying);
            console.log("Voices loaded:", voices.length);
        } else {
            console.log("No voices available yet");
        }
    }
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    }

    function startSpeech() {
        try {
            console.log("startSpeech called");
            if (typeof speechSynthesis === 'undefined') {
                window.speechSynthesis = window.webkitSpeechSynthesis || window.mozSpeechSynthesis;
                console.log("Tried to use alternative speechSynthesis");
            }
            if (!window.speechSynthesis) {
                console.error("Speech synthesis not available in this browser");
                alert("Speech synthesis is not supported in your browser");
                return;
            }
            const text = document.getElementById('speech-text').value.trim();
            if (text.length === 0) {
                console.log("No text to speak");
                return;
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            try {
                const voiceSelect = document.getElementById('voice-select');
                const voices = window.speechSynthesis.getVoices();
                const voiceIndex = parseInt(voiceSelect.value);
                if (voices && voices.length > 0 && voiceIndex >= 0 && voiceIndex < voices.length) {
                    utterance.voice = voices[voiceIndex];
                    console.log("Set voice to:", voices[voiceIndex].name);
                } else {
                    console.log("Using default voice");
                }
            } catch (e) {
                console.error("Error setting voice:", e);
            }
            utterance.rate = parseFloat(document.getElementById('rate-slider').value);
            utterance.volume = parseFloat(document.getElementById('speech-volume-slider').value);
            console.log("Speaking with rate:", utterance.rate, "volume:", utterance.volume);
            isSpeaking = true;
            document.getElementById('speak-btn').disabled = true;
            document.getElementById('stop-speech-btn').disabled = false;
            window.speechSynthesis.speak(utterance);
            console.log("Speech started");
            utterance.onend = function () {
                console.log("Speech ended");
                isSpeaking = false;
                document.getElementById('speak-btn').disabled = false;
                document.getElementById('stop-speech-btn').disabled = true;
            };
            utterance.onerror = function (event) {
                console.error("Speech error:", event);
                isSpeaking = false;
                document.getElementById('speak-btn').disabled = false;
                document.getElementById('stop-speech-btn').disabled = true;
            };
            speechUtterance = utterance;
        } catch (error) {
            console.error("Error in startSpeech:", error);
            alert("Error starting speech: " + error.message);
        }
    }

    function stopSpeech() {
        try {
            console.log("stopSpeech called");
            window.speechSynthesis.cancel();
            isSpeaking = false;
            document.getElementById('speak-btn').disabled = false;
            document.getElementById('stop-speech-btn').disabled = true;
            console.log("Speech stopped");
        } catch (error) {
            console.error("Error stopping speech:", error);
        }
    }

    // --- (Other functions for Tone.js oscillators, event listeners, etc remain unchanged) ---
</script>
<!-- Add a hidden button that can be shown via console if everything else fails -->
<button id="emergency-speech" onclick="emergencySpeech()" style="display: none; position: fixed; bottom: 10px; right: 10px; z-index: 9999; 
                   background-color: red; color: white; padding: 10px; border: none; border-radius: 5px;">
    Emergency Speech
</button>

<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainwave Binaural Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.37/Tone.js"></script>
    <style>
        /* Base Styles - Light Mode by Default */
        :root {
            --bg-color: #f9fafb;
            --container-bg: white;
            --text-color: #1f2937;
            --panel-bg: #f8fafc;
            --border-color: #e5e7eb;
            --info-bg: #eff6ff;
            --info-border: #bfdbfe;
            --info-text: #1e40af;
            --info-detail: #1e3a8a;
            --trouble-bg: #fefce8;
            --trouble-border: #fef08a;
            --trouble-text: #854d0e;
            --trouble-detail: #a16207;
            --playing-bg: #dcfce7;
            --playing-border: #86efac;
            --playing-text: #166534;
            --input-bg: white;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Dark Mode Variables */
        .dark-mode {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e5e5e5;
            --panel-bg: #3a3a3a;
            --border-color: #4a4a4a;
            --info-bg: #2c3e50;
            --info-border: #355070;
            --info-text: #90caf9;
            --info-detail: #bbdefb;
            --trouble-bg: #443c14;
            --trouble-border: #665c24;
            --trouble-text: #f0c14b;
            --trouble-detail: #ffe082;
            --playing-bg: #1b4332;
            --playing-border: #2d6a4f;
            --playing-text: #52b788;
            --input-bg: #3a3a3a;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border-radius: 10px;
            box-shadow: var(--box-shadow);
            padding: 24px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .script-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .script-btn {
            background-color: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .script-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .script-btn:hover:not(.active) {
            background-color: #d1d5db;
        }

        .btn-theme {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            transition: background-color 0.2s;
        }

        .btn-theme:hover {
            background-color: var(--border-color);
        }

        /* Speech Panel Styles */

        .speech-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            margin-left: 10px;
        }

        .speech-checkbox input {
            cursor: pointer;
        }

        .speech-panel {
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            background-color: var(--panel-bg);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .speech-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--info-text);
            margin-top: 0;
            margin-bottom: 12px;
            transition: color 0.3s;
        }

        .speech-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 12px;
            resize: vertical;
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .speech-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: flex-start;
        }

        .btn-speech {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-speech:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }

        .btn-speech-stop {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-speech-stop:disabled {
            background-color: #fca5a5;
            cursor: not-allowed;
        }

        .speech-options {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
        }

        .speech-label {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            gap: 4px;
        }

        .speech-select {
            max-width: 180px;
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            font-size: 0.8rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }

        button {
            cursor: pointer;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:active {
            transform: translateY(1px);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-start {
            background-color: #22c55e;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-stop {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .wave-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        @media (min-width: 640px) {
            .wave-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .wave-btn {
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        .wave-btn.active {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }

        .frequency-options {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .freq-btn {
            background-color: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
            padding: 4px 8px;
            font-size: 0.75rem;
        }

        .freq-btn.active {
            background-color: #3b82f6;
            color: white;
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .range-container {
            position: relative;
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 4px;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 999px;
            outline: none;
            /* -webkit-appearance: none; */
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background-color: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background-color: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .custom-range {
            display: none;
            margin-top: 8px;
        }

        .info-panel {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .info-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e40af;
            margin-top: 0;
            margin-bottom: 8px;
        }

        .info-description {
            font-size: 0.875rem;
            color: #1e40af;
            margin-bottom: 12px;
        }

        .info-subtitle {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 4px;
        }

        .info-list {
            font-size: 0.875rem;
            color: #1e3a8a;
            margin: 0;
            padding-left: 20px;
        }

        .info-list li {
            margin-bottom: 4px;
        }

        .troubleshooting {
            background-color: #fefce8;
            border: 1px solid #fef08a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .troubleshooting-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #854d0e;
            margin-top: 0;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .troubleshooting-list {
            font-size: 0.875rem;
            color: #a16207;
            margin: 0;
            padding-left: 24px;
        }

        .troubleshooting-list li {
            margin-bottom: 4px;
        }

        .divider {
            height: 1px;
            background-color: #fef08a;
            margin: 12px 0;
        }

        .playing-indicator {
            background-color: #dcfce7;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: center;
            display: none;
        }

        .playing-text {
            font-weight: 500;
            color: #166534;
            margin: 0 0 4px 0;
        }

        .playing-details {
            font-size: 0.875rem;
            color: #15803d;
            margin: 0 0 4px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Brainwave Binaural Generator</h1>
            <div class="header-buttons">
                <button id="theme-toggle" class="btn-theme" title="Toggle Dark Mode">
                    <span id="theme-icon">🌙</span>
                </button>
                <button id="toggle-btn" class="btn-start">Start</button>
            </div>
        </div>

        <div id="speech-panel" class="speech-panel">
            <h3 class="speech-title">Custom Hypnosis Script</h3>
            <div class="script-buttons">
                <button id="day-script-btn" class="script-btn active">Day Script</button>
                <button id="night-script-btn" class="script-btn">Night Script</button>
            </div>
            <textarea id="speech-text" class="speech-textarea"
                placeholder="Enter your custom hypnosis script here. It will be read aloud over the binaural beats. You can paste in the quantum coding script or write your own affirmations."></textarea>
            <div class="speech-controls">
                <button id="speak-btn" class="btn-speech">Read Script</button>
                <button id="stop-speech-btn" class="btn-speech-stop" disabled>Stop Reading</button>
                <div class="speech-options">
                    <label class="speech-checkbox">
                        <input type="checkbox" id="loop-speech-checkbox">
                        Loop Speech
                    </label>

                    <label class="speech-label">
                        Voice:
                        <select id="voice-select" class="speech-select">
                            <option value="">Loading voices...</option>
                        </select>
                    </label>
                    <label class="speech-label">
                        Rate:
                        <input type="range" id="rate-slider" min="0.5" max="1.5" step="0.1" value="0.8">
                        <span id="rate-value">0.8</span>
                    </label>
                    <label class="speech-label">
                        Volume:
                        <input type="range" id="speech-volume-slider" min="0" max="1" step="0.1" value="0.7">
                        <span id="speech-volume-value">0.7</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="wave-buttons">
            <button id="delta-btn" class="wave-btn" style="background-color: #6366f1;">Delta</button>
            <button id="theta-btn" class="wave-btn active" style="background-color: #3b82f6;">Theta</button>
            <button id="alpha-btn" class="wave-btn" style="background-color: #22c55e;">Alpha</button>
            <button id="lowBeta-btn" class="wave-btn" style="background-color: #eab308;">Low Beta</button>
            <button id="midBeta-btn" class="wave-btn" style="background-color: #f97316;">Mid Beta</button>
            <button id="highBeta-btn" class="wave-btn" style="background-color: #ef4444;">High Beta</button>
            <button id="gamma-btn" class="wave-btn" style="background-color: #a855f7;">Gamma</button>
        </div>

        <div class="control-group">
            <label class="control-label" id="carrier-label">Carrier Frequency: 200 Hz</label>
            <div class="frequency-options">
                <button id="freq-200" class="freq-btn active">200 Hz</button>
                <button id="freq-1000" class="freq-btn">1000 Hz</button>
                <button id="freq-custom" class="freq-btn">Custom</button>
            </div>
            <div id="custom-range" class="custom-range">
                <div class="range-container">
                    <input type="range" id="carrier-slider" min="100" max="2000" step="10" value="200">
                    <div class="range-labels">
                        <span>100 Hz</span>
                        <span>2000 Hz</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" id="beat-label">Binaural Beat (Theta): 6.0 Hz</label>
            <div class="range-container">
                <input type="range" id="beat-slider" min="4" max="8" step="0.1" value="6.0">
                <div class="range-labels">
                    <span id="beat-min">4 Hz</span>
                    <span id="beat-max">8 Hz</span>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" id="volume-label">Volume: -20 dB</label>
            <div class="range-container">
                <input type="range" id="volume-slider" min="-40" max="0" step="1" value="-20">
                <div class="range-labels">
                    <span>Quiet</span>
                    <span>Loud</span>
                </div>
            </div>
        </div>

        <div id="playing-indicator" class="playing-indicator">
            <p class="playing-text">Audio playing: 200Hz carrier with 6.0Hz binaural beat</p>
            <p class="playing-details">Left ear: 200Hz | Right ear: 206Hz</p>
            <p class="playing-details">Remember: You must use headphones to hear binaural beats properly</p>
        </div>
        <h2 class="info-title" id="current-wave-title">Current Wave: Theta</h2>
        <div class="info-panel">
            <p class="info-description" id="wave-description">Deep meditation, REM sleep, creativity</p>

            <h3 class="info-subtitle">How to Use</h3>
            <ul class="info-list">
                <li><strong>HEADPHONES REQUIRED</strong> - binaural beats only work with stereo headphones</li>
                <li>Click the "Start" button and allow audio permissions if prompted</li>
                <li>If no sound, check your volume settings and make sure headphones are connected</li>
                <li>Try increasing the volume slider and your device volume</li>
                <li>Find a quiet, comfortable space</li>
                <li>Start with 10-30 minute sessions</li>
                <li>Different brainwaves support different mental states</li>
            </ul>
        </div>

        <div class="troubleshooting">
            <h3 class="troubleshooting-title">⚠️ Audio Troubleshooting</h3>
            <ol class="troubleshooting-list">
                <li>Make sure your device's volume is turned up</li>
                <li>Use headphones (required for binaural effects)</li>
                <li>Click the Start button and allow any audio permissions</li>
                <li>You should hear a brief test tone when starting</li>
                <li>Increase the volume slider above if needed</li>
            </ol>
            <div class="divider"></div>
            <p class="troubleshooting-title" style="margin-top: 8px;">About Carrier Frequencies:</p>
            <ul class="troubleshooting-list" style="font-size: 0.75rem;">
                <li>200 Hz: Traditional carrier, works well for most people</li>
                <li>1000 Hz: Higher carrier, may be more perceptible to some</li>
                <li>Custom: Choose your preferred carrier frequency</li>
                <li>Note: The binaural effect occurs from the frequency difference between ears</li>
            </ul>
        </div>

    </div>

    <script>
        // Add this at the end of your script
        document.getElementById('speak-btn').onclick = function () {
            console.log("Direct click handler");
            startSpeech();
        };

        let loopSpeech = false;

        // Sample hypnosis script - can be used as default
        const sampleScript = `
Begin by settling into a comfortable seated or reclining position. Gently close your eyes, allowing yourself to relax deeply and fully. Notice the gentle rhythm of your breathing—each inhale bringing refreshing energy, each exhale releasing any lingering tension or distractions. Feel your mind becoming clear, open, and receptive.
Now, deepen your relaxation by focusing on each part of your body. Start with your toes, feeling them loosen and relax. Move up to your feet, ankles, calves, and thighs, allowing any tension to dissolve. Feel the warmth spreading through your hips, abdomen, and chest, each breath bringing a sense of calm. Let your shoulders drop, releasing any tightness, and feel the relaxation extend down your arms, through your hands, and to your fingertips. Allow your neck and jaw to relax, softening the muscles around your face. Finally, let your scalp and forehead smooth out, feeling your entire body sink into a state of profound tranquility.
Imagine yourself at the threshold of your conscious mind and the boundless quantum universe created by God—a place filled with endless opportunities and vibrant creativity. Visualize shimmering particles of light, each a unique hue, dancing around you, each representing infinite possibilities, healing energies, and profound inspiration. Feel these particles gently touching your skin, energizing your body, clearing your mind, and deeply aligning you with your higher purpose. Notice how these particles weave together, forming intricate patterns of light and energy, each pattern a pathway to new insights and discoveries.
Sense these quantum particles activating your mind and awakening profound insights, clarity, and creativity. Imagine vividly your passion for robotics, electronics, and innovative technology coming to life. See yourself effortlessly merging your understanding of the quantum universe with practical designs and projects that profoundly benefit others. Clearly visualize a workshop filled with advanced tools, circuits, sensors, and robots—each representing your inspired ideas and innovative spirit. Imagine the soft hum of machinery, the gentle glow of circuit boards, and the smooth movements of robotic arms, all guided by your intuitive understanding of the quantum field. See yourself collaborating with like-minded individuals, sharing ideas and building something truly extraordinary.
Now, expand your vision. Imagine not just the workshop, but the applications of your creations. See your robots assisting in healthcare, performing delicate surgeries with unparalleled precision. Visualize your electronic devices enhancing communication for those with disabilities, bridging gaps and fostering connection. See your innovative technologies contributing to sustainable energy solutions, harmonizing technology with nature.
Silently affirm:
“I am divinely guided, connected deeply with infinite wisdom and creativity.”
“My mind effortlessly generates brilliant, innovative solutions and breakthroughs, drawing from the infinite wellspring of the quantum universe.”
“I confidently and passionately create transformative technologies for myself and others, driven by a deep sense of purpose and divine inspiration.”
“I joyfully explore God’s quantum universe, unlocking profound insights and truths, and translating them into tangible, positive change.”
“I am a conduit for divine innovation, bringing forth solutions that uplift and empower humanity.”
“My creations are infused with the harmonious energies of the quantum field, fostering healing and growth.”
Allow these affirmations to deeply resonate within your subconscious mind, filling you with excitement, joy, and confidence. Clearly feel yourself living your purpose, creating meaningful solutions, and experiencing deep satisfaction in your daily life. Feel the profound sense of connection to the divine, knowing you are a vital part of a grand, interconnected universe.
When you’re ready, gently bring your awareness back to the present moment, feeling refreshed, alert, energized, and deeply aligned with your purpose and potential. Take a few deep breaths, wiggle your fingers and toes, and open your eyes, carrying the clarity and inspiration with you throughout your day.`;

        // Brainwave frequency ranges and descriptions
        const brainwaveRanges = {
            delta: { min: 0.5, max: 4, description: "Deep sleep, healing, dreamless sleep", color: "#6366f1" },
            theta: { min: 4, max: 8, description: "Deep meditation, REM sleep, creativity", color: "#3b82f6" },
            alpha: { min: 8, max: 12, description: "Relaxed alertness, calm focus, flow state", color: "#22c55e" },
            lowBeta: { min: 12, max: 15, description: "Relaxed focus, calm thinking", color: "#eab308" },
            midBeta: { min: 15, max: 20, description: "Active engagement, learning", color: "#f97316" },
            highBeta: { min: 20, max: 30, description: "Alertness, problem solving", color: "#ef4444" },
            gamma: { min: 30, max: 50, description: "Higher cognitive processing, peak concentration", color: "#a855f7" }
        };

        // State variables
        let isPlaying = false;
        let waveType = 'theta';
        let frequency = 200;
        let binauralBeat = 6.0;
        let volume = -20;
        let leftOsc, rightOsc, leftChannel, rightChannel, testTone;
        let speechSynthesis = window.speechSynthesis;
        let speechUtterance = null;
        let voices = [];
        let isSpeaking = false;
        let speechRate = 0.8;
        let speechVolume = 0.7;

        // HTML Elements
        const toggleBtn = document.getElementById('toggle-btn');
        const carrierLabel = document.getElementById('carrier-label');
        const carrierSlider = document.getElementById('carrier-slider');
        const beatLabel = document.getElementById('beat-label');
        const beatSlider = document.getElementById('beat-slider');
        const beatMin = document.getElementById('beat-min');
        const beatMax = document.getElementById('beat-max');
        const volumeLabel = document.getElementById('volume-label');
        const volumeSlider = document.getElementById('volume-slider');
        const playingIndicator = document.getElementById('playing-indicator');
        const currentWaveTitle = document.getElementById('current-wave-title');
        const waveDescription = document.getElementById('wave-description');
        const customRange = document.getElementById('custom-range');
        const freq200 = document.getElementById('freq-200');
        const freq1000 = document.getElementById('freq-1000');
        const freqCustom = document.getElementById('freq-custom');

        // Speech Elements
        const speechText = document.getElementById('speech-text');
        const speakBtn = document.getElementById('speak-btn');
        const stopSpeechBtn = document.getElementById('stop-speech-btn');
        const voiceSelect = document.getElementById('voice-select');
        const rateSlider = document.getElementById('rate-slider');
        const rateValue = document.getElementById('rate-value');
        const speechVolumeSlider = document.getElementById('speech-volume-slider');
        const speechVolumeValue = document.getElementById('speech-volume-value');

        // Wave type buttons
        const waveButtons = {
            delta: document.getElementById('delta-btn'),
            theta: document.getElementById('theta-btn'),
            alpha: document.getElementById('alpha-btn'),
            lowBeta: document.getElementById('lowBeta-btn'),
            midBeta: document.getElementById('midBeta-btn'),
            highBeta: document.getElementById('highBeta-btn'),
            gamma: document.getElementById('gamma-btn')
        };

        // Initialize Tone.js
        Tone.context.latencyHint = 'interactive';

        // Setup oscillators
        function setupOscillators() {
            // Create separate channels for left and right
            leftChannel = new Tone.Channel({ volume: volume }).toDestination();
            rightChannel = new Tone.Channel({ volume: volume }).toDestination();

            // Create the panners
            const leftPanner = new Tone.Panner(-1).connect(leftChannel);
            const rightPanner = new Tone.Panner(1).connect(rightChannel);

            // Create oscillators
            leftOsc = new Tone.Oscillator({
                frequency: frequency,
                type: "sine",
                volume: 0 // Volume handled by channel
            }).connect(leftPanner);

            rightOsc = new Tone.Oscillator({
                frequency: frequency + binauralBeat,
                type: "sine",
                volume: 0 // Volume handled by channel
            }).connect(rightPanner);

            // Add a test tone
            testTone = new Tone.Oscillator({
                frequency: 440, // A4 note
                type: "triangle",
                volume: -20
            }).toDestination();

            // Start the test tone for 1 second then stop
            testTone.start();
            setTimeout(() => testTone.stop(), 1000);
        }

        // Update oscillator parameters
        function updateOscillators() {
            if (isPlaying && leftOsc && rightOsc) {
                leftOsc.frequency.value = frequency;
                rightOsc.frequency.value = frequency + binauralBeat;

                if (leftChannel && rightChannel) {
                    leftChannel.volume.value = volume;
                    rightChannel.volume.value = volume;
                }
            }
        }

        // Toggle play/pause
        async function togglePlay() {
            try {
                // Start audio context if needed
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                    console.log("Tone.js audio context started");
                }

                if (!isPlaying) {
                    console.log("Setting up oscillators");
                    setupOscillators();

                    console.log(`Starting oscillators: Left=${frequency}Hz, Right=${frequency + binauralBeat}Hz`);
                    leftOsc.start();
                    rightOsc.start();

                    console.log("Oscillators started successfully");

                    toggleBtn.textContent = 'Stop';
                    toggleBtn.className = 'btn-stop';
                    playingIndicator.style.display = 'block';
                    updatePlayingIndicator();

                    // Disable frequency select while playing
                    freq200.disabled = true;
                    freq1000.disabled = true;
                    freqCustom.disabled = true;
                    carrierSlider.disabled = true;
                } else {
                    if (leftOsc && rightOsc) {
                        console.log("Stopping oscillators");
                        leftOsc.stop();
                        rightOsc.stop();

                        // Dispose oscillators and channels
                        leftOsc.dispose();
                        rightOsc.dispose();
                        leftChannel.dispose();
                        rightChannel.dispose();

                        console.log("Oscillators stopped and disposed");
                    }

                    toggleBtn.textContent = 'Start';
                    toggleBtn.className = 'btn-start';
                    playingIndicator.style.display = 'none';

                    // Re-enable frequency select
                    freq200.disabled = false;
                    freq1000.disabled = false;
                    freqCustom.disabled = false;
                    carrierSlider.disabled = false;
                }

                isPlaying = !isPlaying;
            } catch (error) {
                console.error("Audio playback error:", error);
                alert("Audio playback error. Please check console for details.");
            }
        }

        // Change wave type
        function changeWaveType(type) {
            // Skip if same type or audio is playing
            if (type === waveType || isPlaying) return;

            // Update active button
            waveButtons[waveType].classList.remove('active');
            waveButtons[type].classList.add('active');

            // Update wave type
            waveType = type;

            // Update wave details
            currentWaveTitle.textContent = `Current Wave: ${waveType.charAt(0).toUpperCase() + waveType.slice(1)}`;
            waveDescription.textContent = brainwaveRanges[type].description;

            // Update beat slider range
            const range = brainwaveRanges[type];
            beatSlider.min = range.min;
            beatSlider.max = range.max;
            beatMin.textContent = `${range.min} Hz`;
            beatMax.textContent = `${range.max} Hz`;

            // Set beat to middle of range
            const middleValue = (range.min + range.max) / 2;
            binauralBeat = parseFloat(middleValue.toFixed(1));
            beatSlider.value = binauralBeat;
            updateBeatLabel();
        }

        // Update carrier frequency
        function updateCarrier(newFreq, isCustom = false) {
            if (isPlaying) return;

            frequency = newFreq;
            carrierSlider.value = newFreq;
            carrierLabel.textContent = `Carrier Frequency: ${frequency} Hz`;

            // Update button states
            freq200.classList.remove('active');
            freq1000.classList.remove('active');
            freqCustom.classList.remove('active');

            if (isCustom) {
                freqCustom.classList.add('active');
                customRange.style.display = 'block';
            } else {
                customRange.style.display = 'none';
                if (newFreq === 200) {
                    freq200.classList.add('active');
                } else if (newFreq === 1000) {
                    freq1000.classList.add('active');
                }
            }
        }

        // Update beat label
        function updateBeatLabel() {
            beatLabel.textContent = `Binaural Beat (${waveType.charAt(0).toUpperCase() + waveType.slice(1)}): ${binauralBeat.toFixed(1)} Hz`;
        }

        // Update volume label
        function updateVolumeLabel() {
            volumeLabel.textContent = `Volume: ${volume} dB`;
        }

        // Update playing indicator
        function updatePlayingIndicator() {
            if (!playingIndicator) return;

            const indicator = playingIndicator.getElementsByClassName('playing-text')[0];
            const details = playingIndicator.getElementsByClassName('playing-details')[0];

            indicator.textContent = `Audio playing: ${frequency}Hz carrier with ${binauralBeat.toFixed(1)}Hz binaural beat`;
            details.textContent = `Left ear: ${frequency}Hz | Right ear: ${(frequency + binauralBeat).toFixed(1)}Hz`;
        }

        // Event Listeners
        toggleBtn.addEventListener('click', togglePlay);

        // Wave type buttons
        Object.keys(waveButtons).forEach(type => {
            waveButtons[type].addEventListener('click', () => changeWaveType(type));
        });

        // Frequency buttons
        freq200.addEventListener('click', () => updateCarrier(200));
        freq1000.addEventListener('click', () => updateCarrier(1000));
        freqCustom.addEventListener('click', () => updateCarrier(carrierSlider.value, true));

        // Carrier slider
        carrierSlider.addEventListener('input', () => {
            frequency = parseInt(carrierSlider.value);
            carrierLabel.textContent = `Carrier Frequency: ${frequency} Hz`;
        });

        // Beat slider
        beatSlider.addEventListener('input', () => {
            binauralBeat = parseFloat(beatSlider.value);
            updateBeatLabel();
            updateOscillators();
            updatePlayingIndicator();
        });

        // Volume slider
        volumeSlider.addEventListener('input', () => {
            volume = parseInt(volumeSlider.value);
            updateVolumeLabel();
            updateOscillators();
        });

        // Clean up function for page unload
        window.addEventListener('beforeunload', () => {
            if (isPlaying && leftOsc && rightOsc) {
                leftOsc.stop();
                rightOsc.stop();
                leftOsc.dispose();
                rightOsc.dispose();
                leftChannel.dispose();
                rightChannel.dispose();
            }
        });

        // Speech synthesis functions
        function loadVoices() {
            voices = speechSynthesis.getVoices();

            if (voices.length > 0) {
                // Clear dropdown
                voiceSelect.innerHTML = '';

                // Add voices to select
                voices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    voiceSelect.appendChild(option);
                });

                // Try to select an English voice by default
                let englishVoiceIndex = voices.findIndex(voice =>
                    voice.lang.includes('en') && !voice.name.includes('Google'));

                if (englishVoiceIndex === -1) {
                    englishVoiceIndex = 0; // Fallback to first voice
                }

                voiceSelect.value = englishVoiceIndex;

                // Enable speak button if text is present and audio is playing
                speakBtn.disabled = !(speechText.value.trim().length > 0 && isPlaying);
                console.log("Voices loaded:", voices.length);
            } else {
                console.log("No voices available yet");
            }
        }

        // Load voices when they change
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        // Start speech
        function startSpeech() {
            try {
                console.log("startSpeech called");

                // Force speechSynthesis to be available
                if (typeof speechSynthesis === 'undefined') {
                    window.speechSynthesis = window.webkitSpeechSynthesis || window.mozSpeechSynthesis;
                    console.log("Tried to use alternative speechSynthesis");
                }

                if (!window.speechSynthesis) {
                    console.error("Speech synthesis not available in this browser");
                    alert("Speech synthesis is not supported in your browser");
                    return;
                }

                // Get text from textarea
                const text = document.getElementById('speech-text').value.trim();
                if (text.length === 0) {
                    console.log("No text to speak");
                    return;
                }

                // Cancel any previous speech
                window.speechSynthesis.cancel();

                // Create new utterance
                const utterance = new SpeechSynthesisUtterance(text);

                // Try to set voice
                try {
                    const voiceSelect = document.getElementById('voice-select');
                    const voices = window.speechSynthesis.getVoices();
                    const voiceIndex = parseInt(voiceSelect.value);

                    if (voices && voices.length > 0 && voiceIndex >= 0 && voiceIndex < voices.length) {
                        utterance.voice = voices[voiceIndex];
                        console.log("Set voice to:", voices[voiceIndex].name);
                    } else {
                        console.log("Using default voice");
                    }
                } catch (e) {
                    console.error("Error setting voice:", e);
                }

                // Set rate and volume
                utterance.rate = parseFloat(document.getElementById('rate-slider').value);
                utterance.volume = parseFloat(document.getElementById('speech-volume-slider').value);

                console.log("Speaking with rate:", utterance.rate, "volume:", utterance.volume);

                // Set flag and update UI
                isSpeaking = true;
                document.getElementById('speak-btn').disabled = true;
                document.getElementById('stop-speech-btn').disabled = false;

                // Speak!
                window.speechSynthesis.speak(utterance);
                console.log("Speech started");

                // Update when finished
                utterance.onend = function () {
                    console.log("Speech ended");
                    isSpeaking = false;
                    document.getElementById('speak-btn').disabled = false;
                    document.getElementById('stop-speech-btn').disabled = true;
                };

                utterance.onerror = function (event) {
                    console.error("Speech error:", event);
                    isSpeaking = false;
                    document.getElementById('speak-btn').disabled = false;
                    document.getElementById('stop-speech-btn').disabled = true;
                };

                // Save reference to utterance
                speechUtterance = utterance;

            } catch (error) {
                console.error("Error in startSpeech:", error);
                alert("Error starting speech: " + error.message);
            }
        }

        // Stop speech
        function stopSpeech() {
            try {
                console.log("stopSpeech called");
                window.speechSynthesis.cancel();
                isSpeaking = false;
                document.getElementById('speak-btn').disabled = false;
                document.getElementById('stop-speech-btn').disabled = true;
                console.log("Speech stopped");
            } catch (error) {
                console.error("Error stopping speech:", error);
            }
        }

        // Directly bind the click event for the speech buttons
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('speak-btn').onclick = function () {
                startSpeech();
            };

            document.getElementById('stop-speech-btn').onclick = function () {
                stopSpeech();
            };

            // Also manually enable the button after binaural starts
            document.getElementById('toggle-btn').addEventListener('click', function () {
                setTimeout(function () {
                    if (isPlaying) {
                        document.getElementById('speak-btn').disabled = false;
                    } else {
                        document.getElementById('speak-btn').disabled = true;
                    }
                }, 500);
            });

            // Check for saved preference
            const savedDarkMode = localStorage.getItem('binaural-dark-mode');
            if (savedDarkMode === 'true') {
                toggleDarkMode(); // This will flip isDarkMode to true
            }

            // Add click event for theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);
        });

        // Speech parameters
        rateSlider.addEventListener('input', () => {
            speechRate = parseFloat(rateSlider.value);
            rateValue.textContent = speechRate.toFixed(1);
        });

        speechVolumeSlider.addEventListener('input', () => {
            speechVolume = parseFloat(speechVolumeSlider.value);
            speechVolumeValue.textContent = speechVolume.toFixed(1);
        });

        // Update speech button state when audio starts/stops
        const updateSpeechButtonState = () => {
            if (speakBtn) {
                speakBtn.disabled = !isPlaying;
                console.log("Updated speak button state: disabled =", !isPlaying);
            }
            if (!isPlaying && isSpeaking) {
                stopSpeech();
            }
        };

        // Add the sample script to the textarea
        speechText.value = sampleScript;

        // Add speech button update to toggle play
        const originalTogglePlay = togglePlay;
        togglePlay = async function () {
            await originalTogglePlay.call(this);
            updateSpeechButtonState();
        };

        // Initialize UI
        updateBeatLabel();
        updateVolumeLabel();

        // Load voices initially
        setTimeout(() => {
            loadVoices();
            // Check if voices are loaded, if not try again
            if (voices.length === 0) {
                setTimeout(loadVoices, 1000);
            }
        }, 100);

        const dayScript = `Begin by settling into a comfortable seated or reclining position. Gently close your eyes, allowing yourself to relax deeply and fully. Notice the gentle rhythm of your breathing—each inhale bringing refreshing energy, each exhale releasing any lingering tension or distractions. Feel your mind becoming clear, open, and receptive.
Now, deepen your relaxation by focusing on each part of your body. Start with your toes, feeling them loosen and relax. Move up to your feet, ankles, calves, and thighs, allowing any tension to dissolve. Feel the warmth spreading through your hips, abdomen, and chest, each breath bringing a sense of calm. Let your shoulders drop, releasing any tightness, and feel the relaxation extend down your arms, through your hands, and to your fingertips. Allow your neck and jaw to relax, softening the muscles around your face. Finally, let your scalp and forehead smooth out, feeling your entire body sink into a state of profound tranquility.
Imagine yourself at the threshold of your conscious mind and the boundless quantum universe created by God—a place filled with endless opportunities and vibrant creativity. Visualize shimmering particles of light, each a unique hue, dancing around you, each representing infinite possibilities, healing energies, and profound inspiration. Feel these particles gently touching your skin, energizing your body, clearing your mind, and deeply aligning you with your higher purpose. Notice how these particles weave together, forming intricate patterns of light and energy, each pattern a pathway to new insights and discoveries.
Sense these quantum particles activating your mind and awakening profound insights, clarity, and creativity. Imagine vividly your passion for robotics, electronics, and innovative technology coming to life. See yourself effortlessly merging your understanding of the quantum universe with practical designs and projects that profoundly benefit others. Clearly visualize a workshop filled with advanced tools, circuits, sensors, and robots—each representing your inspired ideas and innovative spirit. Imagine the soft hum of machinery, the gentle glow of circuit boards, and the smooth movements of robotic arms, all guided by your intuitive understanding of the quantum field. See yourself collaborating with like-minded individuals, sharing ideas and building something truly extraordinary.
Now, expand your vision. Imagine not just the workshop, but the applications of your creations. See your robots assisting in healthcare, performing delicate surgeries with unparalleled precision. Visualize your electronic devices enhancing communication for those with disabilities, bridging gaps and fostering connection. See your innovative technologies contributing to sustainable energy solutions, harmonizing technology with nature.
Silently affirm:
“I am divinely guided, connected deeply with infinite wisdom and creativity.”
“My mind effortlessly generates brilliant, innovative solutions and breakthroughs, drawing from the infinite wellspring of the quantum universe.”
“I confidently and passionately create transformative technologies for myself and others, driven by a deep sense of purpose and divine inspiration.”
“I joyfully explore God’s quantum universe, unlocking profound insights and truths, and translating them into tangible, positive change.”
“I am a conduit for divine innovation, bringing forth solutions that uplift and empower humanity.”
“My creations are infused with the harmonious energies of the quantum field, fostering healing and growth.”
Allow these affirmations to deeply resonate within your subconscious mind, filling you with excitement, joy, and confidence. Clearly feel yourself living your purpose, creating meaningful solutions, and experiencing deep satisfaction in your daily life. Feel the profound sense of connection to the divine, knowing you are a vital part of a grand, interconnected universe.
When you’re ready, gently bring your awareness back to the present moment, feeling refreshed, alert, energized, and deeply aligned with your purpose and potential. Take a few deep breaths, wiggle your fingers and toes, and open your eyes, carrying the clarity and inspiration with you throughout your day.`;

        const nightScript = `Settle comfortably into your bed, gently close your eyes, and allow your body to begin relaxing deeply. Take slow, deep breaths, noticing each inhale soothing and calming your mind, and each exhale releasing stress, tension, or worries from your day. Allow a sense of calmness and peace to gently envelop you.
Now, deepen your relaxation by focusing on your body. Feel the weight of your body sinking into the mattress, allowing all tension to melt away. Imagine a warm, soothing light flowing through your body, starting at your toes and moving up, relaxing each muscle, each cell, each fiber. Feel the warmth spreading through your legs, your abdomen, your chest, and your arms. Let your neck and shoulders relax, allowing your head to rest comfortably. Feel the muscles of your face soften, and your eyelids grow heavy.
Picture yourself gently floating into an infinite expanse of soft, comforting quantum energy—a loving creation by God, filled with limitless possibilities and profound healing frequencies. Visualize countless shimmering particles of gentle, healing light surrounding you, effortlessly nurturing and repairing every part of your body, mind, and spirit. See these particles as tiny, intelligent messengers, each carrying divine love and healing energy.
Feel these quantum particles gently entering your body, healing and restoring you at the deepest cellular levels. Imagine this restorative energy forming a protective cocoon around you, deeply comforting and soothing as you drift further into profound relaxation. Sense your interconnectedness with the quantum field and the divine presence, feeling completely safe, secure, and deeply loved by God and the universe. Imagine this quantum field as a vast, loving ocean, gently cradling you, supporting you, and nourishing you.
Allow your subconscious mind to softly open, effortlessly absorbing the gentle wisdom, clarity, and nurturing frequencies of this quantum universe. Feel yourself effortlessly connecting with God’s infinite intelligence and unconditional love, experiencing a profound sense of peace and clarity. Imagine your mind like a clear, tranquil lake, reflecting the infinite beauty and wisdom of the cosmos.
Silently affirm:
“I am profoundly connected to the infinite love, wisdom, and healing of God, and I trust in the divine process of restoration.”
“Every night my body restores, heals, and grows stronger, guided by divine intelligence, and I awaken renewed and revitalized.”
“I deeply embrace my passion for robotics and innovation, receiving divine inspiration effortlessly, and my dreams are filled with creative solutions.”
“My dreams clearly guide me to build transformative devices that uplift myself and others, contributing to a world of harmony and well-being.”
“As I sleep, I integrate the profound insights of the quantum universe, transforming my dreams into tangible realities.”
“I release all worries and anxieties, trusting in the divine guidance that leads me to my highest potential.”
Visualize vividly the joyful fulfillment of your highest potential: creating groundbreaking technological solutions, deepening your understanding of quantum principles, and nurturing loving, supportive relationships. Imagine yourself surrounded by the warmth and appreciation of those you have helped. Allow these visions and affirmations to settle deeply within your subconscious, empowering you through the night.
Surrender fully to restful sleep, knowing your subconscious mind continues gently healing, harmonizing, and guiding you toward your highest good. Good night, and awaken renewed—deeply connected to divine wisdom, clarity, and inspiration. Allow the quantum energy to continue its work throughout the night, ensuring a peaceful and restorative sleep.`;

        // Add event listeners when the document is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Get the script buttons and textarea
            const dayScriptBtn = document.getElementById('day-script-btn');
            const nightScriptBtn = document.getElementById('night-script-btn');
            const speechText = document.getElementById('speech-text');

            // Set initial script (night script since it's what you had before)
            speechText.value = nightScript;

            // Add click event for day script
            dayScriptBtn.addEventListener('click', function () {
                speechText.value = dayScript;
                dayScriptBtn.classList.add('active');
                nightScriptBtn.classList.remove('active');
            });

            // Add click event for night script
            nightScriptBtn.addEventListener('click', function () {
                speechText.value = nightScript;
                nightScriptBtn.classList.add('active');
                dayScriptBtn.classList.remove('active');
            });

            // Make sure other event listeners are still working
            // The rest of your DOMContentLoaded events here...
        });

        // Add this to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function () {
            // ... your existing code ...

            // Add loop checkbox event listener
            const loopCheckbox = document.getElementById('loop-speech-checkbox');
            loopCheckbox.addEventListener('change', function () {
                loopSpeech = this.checked;
                console.log("Speech loop set to:", loopSpeech);
            });
        });

        // Modify the startSpeech function to handle looping
        function startSpeech() {
            try {
                console.log("startSpeech called");

                // Force speechSynthesis to be available
                if (typeof speechSynthesis === 'undefined') {
                    window.speechSynthesis = window.webkitSpeechSynthesis || window.mozSpeechSynthesis;
                    console.log("Tried to use alternative speechSynthesis");
                }

                if (!window.speechSynthesis) {
                    console.error("Speech synthesis not available in this browser");
                    alert("Speech synthesis is not supported in your browser");
                    return;
                }

                // Get text from textarea
                const text = document.getElementById('speech-text').value.trim();
                if (text.length === 0) {
                    console.log("No text to speak");
                    return;
                }

                // Cancel any previous speech
                window.speechSynthesis.cancel();

                // Create new utterance
                const utterance = new SpeechSynthesisUtterance(text);

                // Try to set voice
                try {
                    const voiceSelect = document.getElementById('voice-select');
                    const voices = window.speechSynthesis.getVoices();
                    const voiceIndex = parseInt(voiceSelect.value);

                    if (voices && voices.length > 0 && voiceIndex >= 0 && voiceIndex < voices.length) {
                        utterance.voice = voices[voiceIndex];
                        console.log("Set voice to:", voices[voiceIndex].name);
                    } else {
                        console.log("Using default voice");
                    }
                } catch (e) {
                    console.error("Error setting voice:", e);
                }

                // Set rate and volume
                utterance.rate = parseFloat(document.getElementById('rate-slider').value);
                utterance.volume = parseFloat(document.getElementById('speech-volume-slider').value);

                console.log("Speaking with rate:", utterance.rate, "volume:", utterance.volume);

                // Set flag and update UI
                isSpeaking = true;
                document.getElementById('speak-btn').disabled = true;
                document.getElementById('stop-speech-btn').disabled = false;

                // Speak!
                window.speechSynthesis.speak(utterance);
                console.log("Speech started");

                // Update when finished - with looping support
                utterance.onend = function () {
                    console.log("Speech ended");

                    // If looping is enabled, start the speech again
                    if (loopSpeech) {
                        console.log("Looping speech...");
                        // Brief timeout to prevent browser speech synthesis issues
                        setTimeout(startSpeech, 100);
                    } else {
                        isSpeaking = false;
                        document.getElementById('speak-btn').disabled = false;
                        document.getElementById('stop-speech-btn').disabled = true;
                    }
                };

                utterance.onerror = function (event) {
                    console.error("Speech error:", event);
                    isSpeaking = false;
                    document.getElementById('speak-btn').disabled = false;
                    document.getElementById('stop-speech-btn').disabled = true;
                };

                // Save reference to utterance
                speechUtterance = utterance;

            } catch (error) {
                console.error("Error in startSpeech:", error);
                alert("Error starting speech: " + error.message);
            }
        }

        // Modify the stopSpeech function to handle looping
        function stopSpeech() {
            try {
                console.log("stopSpeech called");
                window.speechSynthesis.cancel();
                isSpeaking = false;
                document.getElementById('speak-btn').disabled = false;
                document.getElementById('stop-speech-btn').disabled = true;
                console.log("Speech stopped");
            } catch (error) {
                console.error("Error stopping speech:", error);
            }
        }
    </script>

</body>

</html>